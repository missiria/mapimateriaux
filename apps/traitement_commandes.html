<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
        <head>

            <title>MAPI MATERIAUX - traitement commandes</title>
            <meta http-equiv="pragma" content="no-cache">
            <meta http-equiv="expires" content="0">
            <meta http-equiv="cache-control" content="no-cache">
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
            <link type="text/css" rel="stylesheet" href="../files/bo_style.css" media="screen">
            <link rel="stylesheet" media="screen and (max-width: 640px)" href="../files/smart.css" type="text/css" />
            <link rel="stylesheet" href="../files/themes/base/jquery.ui.all.css">
            <link rel="stylesheet" href="../files/themes/base/validationEngine.jquery.css" type="text/css" media="screen" /> 
            
            <!-- ALL JAVASCRIPT HERE -->
            <script src="../files/js/jquery.js" type="text/javascript"></script>
            <script src="../files/js/jquery.validationEngine-fr.js" type="text/javascript"></script>  
            <script src="../files/js/jquery.validationEngine.js" type="text/javascript"></script>
            <script type="text/javascript">
            function Cloturer(rowTable, sid, prod){
		      var row = document.getElementById('result').rows[rowTable].cells;
		      var Qt_liv = document.getElementById(sid).value;
		      var id = document.getElementById(sid).value;
		      var QTProduct = row[3].innerHTML;
		      if (Qt_liv > 0) {
				$.ajax({
					type: "POST",
					url: "traitement_commandes.php",
					data: "action=send&id="+sid+"&qt="+Qt_liv+"&prd="+prod,
					success: function(response){
						rspDecoded = JSON.parse(response);
						if (rspDecoded.success == 0){
							alert("La quantité à livrér ("+rspDecoded.stresp+") dépasse la quantité commandée.");
							return;
						}
						if (rspDecoded.success == 1){
							document.getElementById(sid).value = rspDecoded.stresp;
							alert("La commande est mise à jour.");
							return;
						}
						if (rspDecoded.success == 2){
							row[8].innerHTML = "Cloturé";
							document.getElementById(sid).value = rspDecoded.stresp;
							alert("La commande à été cloturée.");
							return;
						}
						if (rspDecoded.success == -1){
							alert("Problème lors de l'opération.");
							return;
						}
						if (rspDecoded.success == -2){
							alert("La quantité ("+Qt_liv+") que vous voulez livrer n'est pas disponible en stock.");
							return;
						}
					}
				});
		      } else {
				alert("La quantité n'est pas valide");
		      }
		      //alert(id + " table :" + rowTable);
		}
		function Verifie(rowTable, id, prod) {
			var row = document.getElementById('result').rows[rowTable].cells;
			var Qt_liv = document.getElementById(id).value;
			var QTProduct = row[3].innerHTML;
			if (Qt_liv > 0 ) {
				$.ajax({
					type: "POST",
					url: "traitement_commandes.php",
					data: "action=verif&prd="+prod,
					success: function(response){
						rspDecoded = JSON.parse(response);
						if (rspDecoded.sumqt < Qt_liv){
							alert("La quantité ("+Qt_liv+") que vous voulez livrer n'est pas disponible en stock. Celle qui est disponinble est : " + rspDecoded.sumqt);
							return;
						} else{
							alert("La quantité que vous voulez livrer est disponible en stock.");
							return;
						}
					}
				});
			} else {
				alert("La quantité n'est pas valide");
			}
		}
		</script>
		<script type="text/javascript">
			  $().ready(function() {
				$('#dialog').jqm();
			  });
		</script>
        </head>

        <body>
            {Header}
            
                  <h3>traitement commandes</h3>

                  <!--Beginblock_search-->
                  <table id="result" border=1>
                        <thead>
                              <td>Bon Info</td>
                              <td>Date</td>
                              <td>Clients</td>
                              <td>QT commandée</td>
                              
                              
                              <td>QT livrée</td>
                              <td>Transporteur</td>
                              <td>l'Heure départ</td>
                              <td>Imperimer</td>
                              <td>Cloturer</td>
                        </thead>
                        <!--Beginrow_result-->
                        <tr>
                              <td>{id}</td>
                              <td>{date}</td>
                              <td>{ref_client}</td>
                              <td>{qt_produit}</td>
                              
                              
                              <td>
                                    <form name="form{id}" mehod="GET" action="{FileName}">
                                    <input id="{id}" type="text" size="4" name="qt_liv" value="{qt_liv}" class="validate[required,custom[onlyNumber]] text-input">
                                    <input type="hidden" name="id" id="id" value="{id}" />
                                    <a href="javascript:" Onclick="Verifie({ordrRow}, {id}, {ref_prod})">Verifie</a>
                                    </form>
                              </td>
                              <td>
                              <div class="row vehiculeIn row{id}">
                              <select name="ref_vehiculeIn" id="ref_vehiculeIn" class="validate[required]">
                              <option value="">Vehicule Interne</option>
                              <!--Beginselect_vehiculeIn-->
                              <option value="{Value_vehiculeIn}" {Selected}>{id_vehiculeIn}</option>
                              <!--Endselect_vehiculeIn--></select><br />
                              </div>
                              
                              <div class="row vehiculeEx row{id}">
                              <select name="ref_vehiculeEx" id="ref_vehiculeEx" class="validate[required]">
                              <option value="">Vehicule Externe</option>
                              <!--Beginselect_vehiculeEx-->
                              <option value="{Value_vehiculeEx}" {Selected}>{id_vehiculeEx}</option>
                              <!--Endselect_vehiculeEx--></select><br />
                              <div>
                              
                              </td>
                              <td><input type="text" size="7" value="09:00"></td>
                              <td><a href="print_commandes.php?id={id}&date={date}&client={ref_client}&qt_produit={qt_produit}&qt_liv={qt_liv}" class="print">print</a> 
                              </td>
                              <td><!--BeginEstCloturable--><a href="javascript:" Onclick="Cloturer({ordrRow}, {id}, {ref_prod})">Cloturer</a><!--EndEstCloturable--><!--BeginEstNonCloturable-->Cloturé<!--EndEstNonCloturable--></td>
                        </tr>
                        <!--Endrow_result-->
                        <!--BeginNorow_result-->
                        <tr>
                              <td colspan="7">Pas d'enregistrement</td>
                        </tr>
                        <!--EndNorow_result-->                                    
                  </table>
                  
                  
                  <!--Endblock_search-->
            {Footer}
        </body>
</html>

